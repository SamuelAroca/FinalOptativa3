<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Panel de Administraci√≥n - Solicitudes</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 32px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .stat-number {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }
      .stat-label {
        color: #666;
        font-size: 14px;
      }
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow-x: auto;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .search-box {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        width: 300px;
      }
      .filter-buttons {
        display: flex;
        gap: 10px;
      }
      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }
      .filter-btn.active {
        background: #667eea;
        color: white;
      }
      .filter-btn:not(.active) {
        background: #f0f0f0;
        color: #666;
      }
      .filter-btn:hover {
        transform: translateY(-2px);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: #667eea;
        color: white;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        font-weight: bold;
        cursor: pointer;
        user-select: none;
      }
      th:hover {
        background: #5568d3;
      }
      tbody tr:hover {
        background: #f5f5f5;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-pendiente {
        background: #ffeaa7;
        color: #d63031;
      }
      .status-aprobado {
        background: #55efc4;
        color: #00b894;
      }
      .status-rechazado {
        background: #fab1a0;
        color: #d63031;
      }
      .status-cancelado {
        background: #dfe6e9;
        color: #636e72;
      }
      .action-btns {
        display: flex;
        gap: 5px;
      }
      .btn {
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .btn-approve {
        background: #00b894;
        color: white;
      }
      .btn-reject {
        background: #d63031;
        color: white;
      }
      .btn-pdf {
        background: #667eea;
        color: white;
      }
      .btn:hover {
        opacity: 0.8;
        transform: scale(1.05);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .refresh-btn {
        padding: 10px 20px;
        background: white;
        color: #667eea;
        border: 2px solid white;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }
      .refresh-btn:hover {
        background: #667eea;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }
      .back-link {
        display: inline-block;
        color: white;
        text-decoration: none;
        margin-bottom: 20px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        transition: all 0.3s;
      }
      .back-link:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
      }
      .toast {
        min-width: 280px;
        padding: 12px 16px;
        border-radius: 8px;
        color: #fff;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        animation: slideIn 0.2s ease-out;
        font-size: 14px;
      }
      .toast-success { background: #10b981; }
      .toast-error { background: #ef4444; }
      .toast-info { background: #3b82f6; }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Fullscreen loader */
      .loader-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.25);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .spinner {
        width: 44px; height: 44px;
        border: 4px solid #ffffff88;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/" class="back-link">‚Üê Volver al Chat</a>
      <h1>üìä Panel de Administraci√≥n - Solicitudes de Permisos</h1>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total">0</div>
          <div class="stat-label">Total Solicitudes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendientes">0</div>
          <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="aprobadas">0</div>
          <div class="stat-label">Aprobadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="rechazadas">0</div>
          <div class="stat-label">Rechazadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="canceladas">0</div>
          <div class="stat-label">Canceladas</div>
        </div>
      </div>

      <div class="table-container">
        <div class="controls">
          <input
            type="text"
            id="searchBox"
            class="search-box"
            placeholder="Buscar por nombre, correo, tipo..."
          />
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">Todas</button>
            <button class="filter-btn" data-filter="Pendiente">
              Pendientes
            </button>
            <button class="filter-btn" data-filter="Aprobado">Aprobadas</button>
            <button class="filter-btn" data-filter="Rechazado">
              Rechazadas
            </button>
            <button class="filter-btn" data-filter="Cancelado">
              Canceladas
            </button>
          </div>
          <button class="refresh-btn" onclick="loadData()">
            üîÑ Actualizar
          </button>
        </div>

        <table>
          <thead>
            <tr>
              <th onclick="sortTable(0)">ID ‚Üï</th>
              <th onclick="sortTable(1)">Nombre ‚Üï</th>
              <th onclick="sortTable(2)">Correo ‚Üï</th>
              <th onclick="sortTable(3)">Tipo ‚Üï</th>
              <th onclick="sortTable(4)">Inicio ‚Üï</th>
              <th onclick="sortTable(5)">Fin ‚Üï</th>
              <th onclick="sortTable(6)">Motivo ‚Üï</th>
              <th onclick="sortTable(7)">Estado ‚Üï</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="9" class="empty-state">Cargando datos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Toasts and Loader -->
    <div id="toastContainer" class="toast-container"></div>
    <div id="loader" class="loader-overlay"><div class="spinner"></div></div>

    <script>
      let allData = [];
      let currentFilter = "all";
      let sortDirection = {};
      const processingIds = new Set();

      function showToast(type, message, timeout = 2500) {
        const container = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = `toast toast-${type}`;
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(-6px)';
          setTimeout(() => el.remove(), 180);
        }, timeout);
      }

      function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
      }

      // Load data on page load
      loadData();

      async function loadData() {
        try {
          const res = await fetch("http://127.0.0.1:5000/api/solicitudes");
          allData = await res.json();
          updateStats();
          renderTable(filterData(allData));
        } catch (error) {
          document.getElementById("tableBody").innerHTML =
            '<tr><td colspan="9" class="empty-state">Error al cargar datos</td></tr>';
        }
      }

      function updateStats() {
        const total = allData.length;
        const pendientes = allData.filter(
          (s) => s.estado === "Pendiente"
        ).length;
        const aprobadas = allData.filter((s) => s.estado === "Aprobado").length;
        const rechazadas = allData.filter(
          (s) => s.estado === "Rechazado"
        ).length;
        const canceladas = allData.filter(
          (s) => s.estado === "Cancelado"
        ).length;

        document.getElementById("total").textContent = total;
        document.getElementById("pendientes").textContent = pendientes;
        document.getElementById("aprobadas").textContent = aprobadas;
        document.getElementById("rechazadas").textContent = rechazadas;
        document.getElementById("canceladas").textContent = canceladas;
      }

      function filterData(data) {
        const searchTerm = document
          .getElementById("searchBox")
          .value.toLowerCase();

        let filtered = data;

        // Filter by status
        if (currentFilter !== "all") {
          filtered = filtered.filter((s) => s.estado === currentFilter);
        }

        // Filter by search term
        if (searchTerm) {
          filtered = filtered.filter(
            (s) =>
              s.nombre.toLowerCase().includes(searchTerm) ||
              s.correo.toLowerCase().includes(searchTerm) ||
              s.tipo.toLowerCase().includes(searchTerm) ||
              s.motivo.toLowerCase().includes(searchTerm)
          );
        }

        return filtered;
      }

      function renderTable(data) {
        const tbody = document.getElementById("tableBody");

        if (data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" class="empty-state">No hay solicitudes para mostrar</td></tr>';
          return;
        }

        tbody.innerHTML = data
          .map(
            (s) => `
          <tr>
            <td>${s.id}</td>
            <td>${s.nombre}</td>
            <td>${s.correo}</td>
            <td>${s.tipo}</td>
            <td>${s.inicio}</td>
            <td>${s.fin}</td>
            <td>${s.motivo.substring(0, 50)}${
              s.motivo.length > 50 ? "..." : ""
            }</td>
            <td><span class="status status-${s.estado.toLowerCase()}">${
              s.estado
            }</span></td>
            <td>
              <div class="action-btns">
                <button class="btn btn-approve" onclick="updateStatus(event, ${
                  s.id
                }, 'Aprobado')" ${
              s.estado === "Aprobado" ? "disabled" : ""
            } title="Aprobar">‚úì</button>
                <button class="btn btn-reject" onclick="updateStatus(event, ${
                  s.id
                }, 'Rechazado')" ${
              s.estado === "Rechazado" ? "disabled" : ""
            } title="Rechazar">‚úó</button>
                <button class="btn btn-pdf" onclick="downloadPDF(${
                  s.id
                })" title="Descargar PDF">üìÑ</button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      async function updateStatus(event, id, estado) {
        // Prevent double processing on same row
        if (processingIds.has(id)) return;
        processingIds.add(id);

        const btn = event?.currentTarget;
        const row = btn ? btn.closest('tr') : null;
        // Disable action buttons on row
        if (row) row.querySelectorAll('.btn').forEach(b => b.disabled = true);
        showLoader(true);
        showToast('info', `Procesando #${id} ‚Üí ${estado}...`, 1200);
        try {
          const res = await fetch(
            `http://127.0.0.1:5000/api/solicitudes/${id}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ estado }),
            }
          );
          if (res.ok) {
            const data = await res.json();
            showToast('success', `‚úÖ ${data.message}`);
            await loadData();
          } else {
            showToast('error', 'No se pudo actualizar el estado');
          }
        } catch (error) {
          showToast('error', 'Error al actualizar el estado');
        } finally {
          processingIds.delete(id);
          showLoader(false);
          // Re-enable row buttons
          if (row) row.querySelectorAll('.btn').forEach(b => b.disabled = false);
        }
      }

      function downloadPDF(id) {
        window.open(
          `http://127.0.0.1:5000/api/solicitudes/${id}/pdf`,
          "_blank"
        );
      }

      function sortTable(columnIndex) {
        const key = [
          "id",
          "nombre",
          "correo",
          "tipo",
          "inicio",
          "fin",
          "motivo",
          "estado",
        ][columnIndex];

        if (!sortDirection[key]) sortDirection[key] = "asc";
        else sortDirection[key] = sortDirection[key] === "asc" ? "desc" : "asc";

        const filtered = filterData(allData);
        const sorted = [...filtered].sort((a, b) => {
          let aVal = a[key];
          let bVal = b[key];

          if (key === "id") {
            aVal = parseInt(aVal);
            bVal = parseInt(bVal);
          }

          if (sortDirection[key] === "asc") {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        renderTable(sorted);
      }

      // Search functionality
      document.getElementById("searchBox").addEventListener("input", () => {
        renderTable(filterData(allData));
      });

      // Filter buttons
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.dataset.filter;
          renderTable(filterData(allData));
        });
      });
    </script>
  </body>
</html>
