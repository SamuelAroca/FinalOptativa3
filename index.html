<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chatbot - Solicitud de Permisos</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #chat {
        max-width: 600px;
        margin: 2rem auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      #header {
        background: #667eea;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
      }
      #messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 80%;
        word-wrap: break-word;
      }
      .user {
        background: #667eea;
        color: white;
        margin-left: auto;
        text-align: right;
      }
      .bot {
        background: white;
        border: 1px solid #ddd;
      }
      #input-container {
        display: flex;
        padding: 15px;
        background: white;
        border-top: 1px solid #ddd;
      }
      #input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        outline: none;
      }
      #input:focus {
        border-color: #667eea;
      }
      #send {
        margin-left: 10px;
        padding: 12px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }
      #send:hover {
        background: #5568d3;
      }
      #send:active {
        transform: scale(0.98);
      }
    </style>
  </head>
  <body>
    <div id="chat">
      <div id="header">
        ðŸ¤– Chatbot - Solicitud de Permisos
        <a
          href="http://127.0.0.1:5000/admin"
          target="_blank"
          style="
            float: right;
            color: white;
            text-decoration: none;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 5px;
            transition: all 0.3s;
          "
          onmouseover="this.style.background='rgba(255,255,255,0.3)'"
          onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >ðŸ“Š Admin</a
        >
      </div>
      <div id="messages"></div>
      <div id="input-container">
        <input
          id="input"
          placeholder="Escribe tu mensaje aquÃ­..."
          autocomplete="off"
        />
        <button id="send">Enviar</button>
      </div>
    </div>

    <script>
      const sessionId = Math.random().toString(36).slice(2, 10);
      const messagesDiv = document.getElementById("messages");
      const inputField = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      let waitingForDate = false; // Flag para saber si esperamos una fecha
      let dateType = null; // 'inicio' o 'fin'

      // Mensaje de bienvenida
      window.onload = () => {
        appendMessage(
          "bot",
          "Â¡Hola! ðŸ‘‹ Bienvenido al sistema de solicitudes de permisos.\n\nÂ¿QuÃ© deseas hacer?\n\n1ï¸âƒ£ Crear nueva solicitud\n2ï¸âƒ£ Consultar una solicitud (muestra las Ãºltimas)\n3ï¸âƒ£ Ver todas mis solicitudes (por correo)\nâŒ Cancelar una solicitud pendiente\n\nðŸ’¡ Tips:\nâ€¢ Al crear una solicitud, podrÃ¡s recibir un PDF por correo\nâ€¢ Si no sabes el nÃºmero, usa la opciÃ³n 3 con tu correo\nâ€¢ Escribe 'cancelar' para anular solicitudes pendientes\n\nTambiÃ©n puedes escribir tu nombre directamente para empezar con una nueva solicitud."
        );
      };

      sendBtn.onclick = sendMessage;
      inputField.onkeypress = (e) => {
        if (e.key === "Enter") sendMessage();
      };

      async function sendMessage() {
        const msg = inputField.value.trim();
        if (!msg) return;

        appendMessage("user", msg);
        inputField.value = "";

        // Deshabilitar input mientras se procesa
        inputField.disabled = true;
        sendBtn.disabled = true;

        try {
          const res = await fetch("http://127.0.0.1:5000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId, message: msg }),
          });
          const j = await res.json();
          appendMessage("bot", j.reply);

          // Detectar si necesitamos mostrar selector de fecha
          if (j.reply.includes("Â¿Fecha de inicio?")) {
            waitingForDate = true;
            dateType = "inicio";
            showDatePicker();
          } else if (j.reply.includes("Â¿Fecha de fin?")) {
            waitingForDate = true;
            dateType = "fin";
            showDatePicker();
          } else {
            waitingForDate = false;
            dateType = null;
          }
        } catch (error) {
          appendMessage(
            "bot",
            "Error al comunicarse con el servidor. Por favor intenta nuevamente."
          );
        } finally {
          // Rehabilitar input
          inputField.disabled = false;
          sendBtn.disabled = false;
          inputField.focus();
        }
      }

      function showDatePicker() {
        // Crear un input de fecha temporal
        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.className = "message user";
        dateInput.style.padding = "10px";
        dateInput.style.border = "2px solid #667eea";
        dateInput.style.borderRadius = "8px";
        dateInput.style.fontSize = "14px";
        dateInput.style.marginLeft = "auto";
        dateInput.style.maxWidth = "80%";
        dateInput.style.cursor = "pointer";

        // Establecer fecha mÃ­nima (hoy)
        const today = new Date().toISOString().split("T")[0];
        dateInput.min = today;

        // Si es fecha de fin, abrir el picker automÃ¡ticamente
        dateInput.focus();

        dateInput.onchange = async () => {
          const selectedDate = dateInput.value;
          if (selectedDate) {
            dateInput.remove();
            inputField.value = selectedDate;
            await sendMessage();
          }
        };

        messagesDiv.appendChild(dateInput);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Abrir el picker automÃ¡ticamente
        setTimeout(() => dateInput.showPicker(), 100);
      }

      function appendMessage(sender, text) {
        const div = document.createElement("div");
        div.className = "message " + sender;
        div.innerHTML = text.replace(/\n/g, "<br>");
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    </script>
  </body>
</html>
