<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chatbot - Solicitud de Permisos</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #chat {
        max-width: 600px;
        margin: 2rem auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      #header {
        background: #667eea;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
      }
      #messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 80%;
        word-wrap: break-word;
      }
      .user {
        background: #667eea;
        color: white;
        margin-left: auto;
        text-align: right;
      }
      .bot {
        background: white;
        border: 1px solid #ddd;
      }
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .btn-option {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
      }
      .btn-option:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .btn-option:active {
        transform: translateY(0);
      }
      #input-container {
        display: flex;
        padding: 15px;
        background: white;
        border-top: 1px solid #ddd;
      }
      #input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        outline: none;
      }
      #input:focus {
        border-color: #667eea;
      }
      #send {
        margin-left: 10px;
        padding: 12px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }
      #send:hover {
        background: #5568d3;
      }
      #send:active {
        transform: scale(0.98);
      }
      #footer {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 12px;
        margin-top: 20px;
        border-radius: 10px;
      }
      #footer a {
        color: white;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="chat">
      <div id="header">
        ü§ñ Chatbot - Solicitud de Permisos
        <a
          href="http://127.0.0.1:5000/admin"
          target="_blank"
          style="
            float: right;
            color: white;
            text-decoration: none;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 5px;
            transition: all 0.3s;
          "
          onmouseover="this.style.background='rgba(255,255,255,0.3)'"
          onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >üìä Admin</a
        >
      </div>
      <div id="messages"></div>
      <div id="input-container">
        <input
          id="input"
          placeholder="Escribe tu mensaje aqu√≠..."
          autocomplete="off"
        />
        <button id="send">Enviar</button>
      </div>
    </div>

    <div id="footer">
      üí° Sistema de Gesti√≥n de Permisos v2.0 |
      <a href="http://127.0.0.1:5000/admin" target="_blank">Panel Admin</a> |
      Escribe "menu" para volver al inicio
    </div>

    <script>
      const sessionId = Math.random().toString(36).slice(2, 10);
      const messagesDiv = document.getElementById("messages");
      const inputField = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      let waitingForDate = false; // Flag para saber si esperamos una fecha
      let dateType = null; // 'inicio' o 'fin'

      // Mensaje de bienvenida
      window.onload = () => {
        showWelcomeMessage();
      };

      function showWelcomeMessage() {
        const welcomeText =
          "¬°Hola! üëã Bienvenido al sistema de solicitudes de permisos.\n\n¬øQu√© deseas hacer?";
        appendMessage("bot", welcomeText);

        // Agregar botones de opciones
        showOptionsButtons([
          { text: "üìù Nueva solicitud", value: "1" },
          { text: "üîç Consultar solicitud", value: "2" },
          { text: "üìã Mis solicitudes", value: "3" },
          { text: "üìä Mis estad√≠sticas", value: "estadisticas" },
          { text: "‚ùå Cancelar solicitud", value: "cancelar" },
        ]);
      }

      function showOptionsButtons(options) {
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "message bot";
        buttonGroup.style.maxWidth = "90%";

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "button-group";

        options.forEach((option) => {
          const btn = document.createElement("button");
          btn.className = "btn-option";
          btn.textContent = option.text;
          btn.onclick = () => {
            inputField.value = option.value;
            sendMessage();
          };
          buttonsContainer.appendChild(btn);
        });

        buttonGroup.appendChild(buttonsContainer);
        messagesDiv.appendChild(buttonGroup);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      sendBtn.onclick = sendMessage;
      inputField.onkeypress = (e) => {
        if (e.key === "Enter") sendMessage();
      };

      async function sendMessage() {
        const msg = inputField.value.trim();
        if (!msg) return;

        appendMessage("user", msg);
        inputField.value = "";

        // Deshabilitar input mientras se procesa
        inputField.disabled = true;
        sendBtn.disabled = true;

        try {
          const res = await fetch("http://127.0.0.1:5000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId, message: msg }),
          });
          const j = await res.json();
          appendMessage("bot", j.reply);

          // Mostrar botones de confirmaci√≥n si/no
          if (j.reply.includes("(si/no)") || j.reply.includes("¬øConfirmas")) {
            showYesNoButtons();
          }

          // Detectar si necesitamos mostrar selector de fecha
          if (j.reply.includes("¬øFecha de inicio?")) {
            waitingForDate = true;
            dateType = "inicio";
            showDatePicker();
          } else if (j.reply.includes("¬øFecha de fin?")) {
            waitingForDate = true;
            dateType = "fin";
            showDatePicker();
          } else {
            waitingForDate = false;
            dateType = null;
          }
        } catch (error) {
          appendMessage(
            "bot",
            "Error al comunicarse con el servidor. Por favor intenta nuevamente."
          );
        } finally {
          // Rehabilitar input
          inputField.disabled = false;
          sendBtn.disabled = false;
          inputField.focus();
        }
      }

      function showDatePicker() {
        // Crear un input de fecha temporal
        const dateInput = document.createElement("input");
        dateInput.type = "date";
        dateInput.className = "message user";
        dateInput.style.padding = "10px";
        dateInput.style.border = "2px solid #667eea";
        dateInput.style.borderRadius = "8px";
        dateInput.style.fontSize = "14px";
        dateInput.style.marginLeft = "auto";
        dateInput.style.maxWidth = "80%";
        dateInput.style.cursor = "pointer";

        // Establecer fecha m√≠nima (hoy)
        const today = new Date().toISOString().split("T")[0];
        dateInput.min = today;

        // Si es fecha de fin, abrir el picker autom√°ticamente
        dateInput.focus();

        dateInput.onchange = async () => {
          const selectedDate = dateInput.value;
          if (selectedDate) {
            dateInput.remove();
            inputField.value = selectedDate;
            await sendMessage();
          }
        };

        messagesDiv.appendChild(dateInput);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Abrir el picker autom√°ticamente
        setTimeout(() => dateInput.showPicker(), 100);
      }

      function showYesNoButtons() {
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "message bot";
        buttonGroup.style.maxWidth = "90%";

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "button-group";

        const yesBtn = document.createElement("button");
        yesBtn.className = "btn-option";
        yesBtn.textContent = "‚úÖ S√≠";
        yesBtn.style.background = "#10b981";
        yesBtn.onclick = () => {
          buttonGroup.remove();
          inputField.value = "si";
          sendMessage();
        };

        const noBtn = document.createElement("button");
        noBtn.className = "btn-option";
        noBtn.textContent = "‚ùå No";
        noBtn.style.background = "#ef4444";
        noBtn.onclick = () => {
          buttonGroup.remove();
          inputField.value = "no";
          sendMessage();
        };

        buttonsContainer.appendChild(yesBtn);
        buttonsContainer.appendChild(noBtn);
        buttonGroup.appendChild(buttonsContainer);
        messagesDiv.appendChild(buttonGroup);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function appendMessage(sender, text) {
        const div = document.createElement("div");
        div.className = "message " + sender;

        // Formato especial para mensajes con emojis de estado
        if (text.includes("‚úÖ") && text.includes("registrada con √©xito")) {
          div.style.background = "#d1fae5";
          div.style.border = "2px solid #10b981";
          div.style.color = "#065f46";
        } else if (text.includes("üìä **ESTAD√çSTICAS")) {
          div.style.background = "#dbeafe";
          div.style.border = "2px solid #3b82f6";
          div.style.color = "#1e40af";
        } else if (text.includes("‚ùå") || text.includes("Error")) {
          div.style.background = "#fee2e2";
          div.style.border = "2px solid #ef4444";
          div.style.color = "#991b1b";
        }

        div.innerHTML = text
          .replace(/\n/g, "<br>")
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    </script>
  </body>
</html>
